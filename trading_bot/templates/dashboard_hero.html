<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bitget Bot | Panel en Tiempo Real</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.1.0/dist/chartjs-plugin-annotation.min.js"></script>
  <style>
    :root {
      color-scheme: dark;
      --bg: #0a0f1f;
      --panel: #0f172a;
      --panel-2: #111c38;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --accent: #38bdf8;
      --accent-2: #22d3ee;
      --success: #22c55e;
      --danger: #f97316;
      --warning: #f59e0b;
      --border: rgba(148, 163, 184, 0.2);
      --shadow: 0 18px 60px rgba(15, 23, 42, 0.55);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Space Grotesk", system-ui, -apple-system, sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #141b2d 0%, #0a0f1f 60%);
      color: var(--text);
      min-height: 100vh;
    }

    header {
      padding: 32px 6vw 18px;
    }

    header h1 {
      font-size: clamp(1.8rem, 2.6vw, 2.8rem);
      letter-spacing: -0.03em;
      margin-bottom: 8px;
    }

    header p {
      color: var(--muted);
      max-width: 720px;
      line-height: 1.6;
    }

    main {
      padding: 0 6vw 48px;
      display: flex;
      flex-direction: column;
      gap: 28px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 18px 20px;
      box-shadow: var(--shadow);
    }

    .card h3 {
      font-size: 0.95rem;
      color: var(--muted);
      margin-bottom: 10px;
      font-weight: 500;
    }

    .card strong {
      font-size: 1.4rem;
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.85rem;
      background: rgba(56, 189, 248, 0.12);
      color: var(--accent);
      border: 1px solid rgba(56, 189, 248, 0.35);
    }

    .split {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
      gap: 18px;
    }

    .panel {
      background: var(--panel-2);
      border-radius: 20px;
      padding: 22px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .panel h2 {
      font-size: 1.2rem;
      margin-bottom: 14px;
    }

    .panel p {
      color: var(--muted);
      margin-bottom: 14px;
    }

    .chart-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
    }

    select {
      background: #0b1226;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      text-align: left;
      padding: 10px 8px;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
    }

    th {
      color: var(--muted);
      font-weight: 500;
    }

    tbody tr:hover {
      background: rgba(56, 189, 248, 0.05);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      display: inline-block;
      margin-right: 6px;
    }

    .muted {
      color: var(--muted);
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .history-item {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.65);
    }

    .history-item small {
      display: block;
      color: var(--muted);
      margin-top: 6px;
    }

    @media (max-width: 980px) {
      .split {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Panel avanzado del bot de trading (Bitget)</h1>
    <p>
      Vista en tiempo real del estado del bot, posiciones abiertas, niveles de TP/SL y
      rendimiento histórico. Los datos se actualizan desde el backend del bot en
      intervalos regulares.
    </p>
  </header>

  <main>
    <section class="grid">
      <div class="card">
        <h3>Estado del bot</h3>
        <strong id="bot-status">Cargando…</strong>
        <span class="pill" id="bot-mode">Modo</span>
      </div>
      <div class="card">
        <h3>Capital disponible</h3>
        <strong id="balance-free">—</strong>
        <span class="muted" id="balance-info">Saldo total —</span>
      </div>
      <div class="card">
        <h3>Posiciones abiertas</h3>
        <strong id="open-positions">0</strong>
        <span class="muted" id="last-update">Actualizado —</span>
      </div>
      <div class="card">
        <h3>Drawdown diario</h3>
        <strong id="drawdown">—</strong>
        <span class="muted" id="drawdown-meta">Balance inicial —</span>
      </div>
    </section>

    <section class="split">
      <div class="panel">
        <div class="chart-header">
          <div>
            <h2>Precio en tiempo real + zonas TP/SL</h2>
            <p class="muted">Selecciona una posición abierta para inspeccionar el gráfico.</p>
          </div>
          <select id="symbol-select"></select>
        </div>
        <canvas id="price-chart" height="180"></canvas>
      </div>
      <div class="panel">
        <h2>Señales y decisiones recientes</h2>
        <p class="muted">Eventos registrados por el bot (aperturas, ajustes, cierres).</p>
        <div class="history-list" id="decisions">Cargando…</div>
      </div>
    </section>

    <section class="panel">
      <h2>Posiciones activas</h2>
      <p class="muted">Detalle de posiciones abiertas con TP/SL actuales.</p>
      <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th>Par</th>
              <th>Side</th>
              <th>Cantidad</th>
              <th>Entrada</th>
              <th>Precio</th>
              <th>TP</th>
              <th>SL</th>
              <th>PnL</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody id="positions-table"></tbody>
        </table>
      </div>
    </section>

    <section class="panel">
      <h2>Historial de operaciones</h2>
      <p class="muted">Últimas operaciones cerradas registradas en el CSV.</p>
      <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th>Par</th>
              <th>Side</th>
              <th>Cantidad</th>
              <th>Entrada</th>
              <th>Salida</th>
              <th>TP</th>
              <th>SL</th>
              <th>Resultado</th>
              <th>Cierre</th>
            </tr>
          </thead>
          <tbody id="history-table"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    const statusEls = {
      botStatus: document.getElementById('bot-status'),
      botMode: document.getElementById('bot-mode'),
      balanceFree: document.getElementById('balance-free'),
      balanceInfo: document.getElementById('balance-info'),
      openPositions: document.getElementById('open-positions'),
      lastUpdate: document.getElementById('last-update'),
      drawdown: document.getElementById('drawdown'),
      drawdownMeta: document.getElementById('drawdown-meta'),
    };

    const positionsTable = document.getElementById('positions-table');
    const historyTable = document.getElementById('history-table');
    const decisionsList = document.getElementById('decisions');
    const symbolSelect = document.getElementById('symbol-select');

    const pricePoints = [];
    const priceLabels = [];

    const chart = new Chart(document.getElementById('price-chart'), {
      type: 'line',
      data: {
        labels: priceLabels,
        datasets: [
          {
            label: 'Precio',
            data: pricePoints,
            borderColor: '#38bdf8',
            backgroundColor: 'rgba(56, 189, 248, 0.15)',
            tension: 0.3,
            fill: true,
          },
        ],
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          annotation: {
            annotations: {},
          },
        },
        scales: {
          x: {
            ticks: { color: '#94a3b8' },
            grid: { color: 'rgba(148, 163, 184, 0.08)' },
          },
          y: {
            ticks: { color: '#94a3b8' },
            grid: { color: 'rgba(148, 163, 184, 0.08)' },
          },
        },
      },
    });

    function formatNumber(value, suffix = '') {
      if (value === null || value === undefined || value === '') return '—';
      const number = Number(value);
      if (Number.isNaN(number)) return '—';
      return `${number.toFixed(2)}${suffix}`;
    }

    function setAnnotations(position) {
      const annotations = {};
      if (position?.take_profit) {
        annotations.tpLine = {
          type: 'line',
          yMin: position.take_profit,
          yMax: position.take_profit,
          borderColor: '#22c55e',
          borderWidth: 2,
          label: {
            display: true,
            content: 'TP',
            backgroundColor: '#22c55e',
            color: '#0f172a',
          },
        };
        annotations.tpZone = {
          type: 'box',
          yMin: position.entry_price || position.take_profit,
          yMax: position.take_profit,
          backgroundColor: 'rgba(34, 197, 94, 0.12)',
          borderWidth: 0,
        };
      }
      if (position?.stop_loss) {
        annotations.slLine = {
          type: 'line',
          yMin: position.stop_loss,
          yMax: position.stop_loss,
          borderColor: '#f97316',
          borderWidth: 2,
          label: {
            display: true,
            content: 'SL',
            backgroundColor: '#f97316',
            color: '#0f172a',
          },
        };
        annotations.slZone = {
          type: 'box',
          yMin: position.stop_loss,
          yMax: position.entry_price || position.stop_loss,
          backgroundColor: 'rgba(249, 115, 22, 0.12)',
          borderWidth: 0,
        };
      }
      chart.options.plugins.annotation.annotations = annotations;
      chart.update('none');
    }

    function updateStatus(status) {
      statusEls.botStatus.textContent = status.trading_enabled ? 'Activo' : 'Pausado';
      statusEls.botMode.textContent = `Modo ${status.bot_mode || '—'}`;
      const balance = status.balance || {};
      statusEls.balanceFree.textContent = formatNumber(balance.free_usdt, ' USDT');
      statusEls.balanceInfo.textContent = `Saldo total ${formatNumber(balance.daily_start_balance, ' USDT')}`;
      statusEls.openPositions.textContent = status.open_positions ?? 0;
      statusEls.lastUpdate.textContent = `Actualizado ${new Date(status.timestamp).toLocaleTimeString()}`;
      statusEls.drawdown.textContent = formatNumber(balance.daily_drawdown_pct, '%');
      statusEls.drawdownMeta.textContent = `Mínimo ${formatNumber(balance.daily_min_balance, ' USDT')}`;
    }

    function renderPositions(positions) {
      positionsTable.innerHTML = '';
      if (!positions.length) {
        positionsTable.innerHTML = '<tr><td colspan="9" class="muted">Sin posiciones activas.</td></tr>';
      }
      const symbols = [];
      positions.forEach((pos) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${pos.symbol || '—'}</td>
          <td>${pos.side || '—'}</td>
          <td>${formatNumber(pos.quantity)}</td>
          <td>${formatNumber(pos.entry_price)}</td>
          <td>${formatNumber(pos.last_price)}</td>
          <td>${formatNumber(pos.take_profit)}</td>
          <td>${formatNumber(pos.stop_loss)}</td>
          <td>${formatNumber(pos.unrealized_pnl, ' USDT')}</td>
          <td><span class="status-dot"></span>${pos.status || '—'}</td>
        `;
        positionsTable.appendChild(row);
        if (pos.symbol) symbols.push(pos.symbol);
      });

      const currentSymbol = symbolSelect.value;
      symbolSelect.innerHTML = '';
      symbols.forEach((symbol) => {
        const option = document.createElement('option');
        option.value = symbol;
        option.textContent = symbol;
        symbolSelect.appendChild(option);
      });
      if (currentSymbol && symbols.includes(currentSymbol)) {
        symbolSelect.value = currentSymbol;
      }
    }

    function renderHistory(items) {
      historyTable.innerHTML = '';
      if (!items.length) {
        historyTable.innerHTML = '<tr><td colspan="9" class="muted">No hay historial disponible.</td></tr>';
      }
      items.forEach((row) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.symbol || '—'}</td>
          <td>${row.side || '—'}</td>
          <td>${formatNumber(row.quantity)}</td>
          <td>${formatNumber(row.entry_price)}</td>
          <td>${formatNumber(row.exit_price)}</td>
          <td>${formatNumber(row.take_profit)}</td>
          <td>${formatNumber(row.stop_loss)}</td>
          <td>${formatNumber(row.profit, ' USDT')}</td>
          <td>${row.close_time || '—'}</td>
        `;
        historyTable.appendChild(tr);
      });
    }

    function renderDecisions(events) {
      decisionsList.innerHTML = '';
      if (!events.length) {
        decisionsList.textContent = 'Sin eventos recientes.';
        return;
      }
      events.slice().reverse().slice(0, 8).forEach((event) => {
        const item = document.createElement('div');
        item.className = 'history-item';
        const snapshot = event.trade_snapshot || {};
        item.innerHTML = `
          <strong>${event.event || 'evento'}</strong>
          <div class="muted">${snapshot.symbol || '—'} · ${snapshot.side || '—'} · ${formatNumber(snapshot.entry_price)}</div>
          <small>${event.timestamp || ''}</small>
        `;
        decisionsList.appendChild(item);
      });
    }

    async function refreshStatus() {
      const response = await fetch('/api/status');
      const status = await response.json();
      updateStatus(status);
    }

    async function refreshPositions() {
      const response = await fetch('/api/positions');
      const positions = await response.json();
      renderPositions(positions);
      const selected = positions.find((pos) => pos.symbol === symbolSelect.value) || positions[0];
      setAnnotations(selected);
    }

    async function refreshHistory() {
      const response = await fetch('/api/history?limit=15');
      const items = await response.json();
      renderHistory(items);
    }

    async function refreshDecisions() {
      const response = await fetch('/api/decisions');
      const events = await response.json();
      renderDecisions(events);
    }

    async function refreshPrice() {
      const symbol = symbolSelect.value;
      if (!symbol) return;
      const response = await fetch(`/api/price?symbol=${encodeURIComponent(symbol)}`);
      const payload = await response.json();
      if (payload?.price) {
        const now = new Date();
        const label = now.toLocaleTimeString();
        priceLabels.push(label);
        pricePoints.push(payload.price);
        if (pricePoints.length > 30) {
          pricePoints.shift();
          priceLabels.shift();
        }
        chart.update('none');
      }
    }

    symbolSelect.addEventListener('change', () => {
      pricePoints.length = 0;
      priceLabels.length = 0;
      chart.update('none');
      refreshPrice();
      refreshPositions();
    });

    async function boot() {
      await Promise.all([refreshStatus(), refreshPositions(), refreshHistory(), refreshDecisions()]);
      await refreshPrice();
      setInterval(refreshStatus, 6000);
      setInterval(refreshPositions, 7000);
      setInterval(refreshHistory, 20000);
      setInterval(refreshDecisions, 12000);
      setInterval(refreshPrice, 5000);
    }

    boot();
  </script>
</body>
</html>
